<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colab FS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> 
    
</head>
<body>
    <div class="container">

        <div class="info-header">
            
            <div class="disk-bar-wrapper">
                
                <div class="disk-item">
                    <strong>Colab ({{ format_size(colab_used) }} / {{ format_size(colab_total) }}):</strong>
                    <div class="progress-bar">
                        <div class="progress" style="width: {{ colab_percent|round(2) }}%;"></div>
                    </div>
                </div>

                {% if drive_total > 0 %}
                <div class="disk-item">
                    <strong>Drive ({{ format_size(drive_used) }} / {{ format_size(drive_total) }}):</strong>
                    <div class="progress-bar">
                        <div class="progress" style="width: {{ drive_percent|round(2) }}%; background-color: #28a745;"></div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="current-path"><strong>Path:</strong> <code>{{ path }}</code></div>
        </div>

        <div id="file-list" class="file-list">
            {% for f in files %}
                {% set target_path = f['full_path'] %}
                {% if f['is_dir'] and f['full_path'] == drive_mount_path and os_path.exists(os_path.join(drive_mount_path, "MyDrive")) %}
                    {% set target_path = os_path.join(drive_mount_path, "MyDrive") %}
                {% endif %}

                {% set icon_class = f['icon_class'] %}
                
                {% if f['is_dir'] %}
                    <a href="/?path={{ target_path }}" class="file-item file-folder" data-path="{{ target_path }}">
                        
                        <span class="file-name-absolute" title="{{ f['name'] }}">{{ f['name'] }}</span>
                        
                        <i class="fas {{ icon_class }} fa-fw"></i>

                        <span class="file-size-absolute">{{ f['size'] }}</span>

                        <div class="file-text-container">
                            <span class="file-name">{{ f['name'] }}</span>
                            <span class="file-size">{{ f['size'] }}</span>
                        </div>
                    </a>
                {% else %}
                    <div class="file-item file-file" data-path="{{ f['full_path'] }}">

                        <span class="file-name-absolute" title="{{ f['name'] }}">{{ f['name'] }}</span>
                        
                        <i class="fas {{ icon_class }} fa-fw"></i>

                        <span class="file-size-absolute">{{ f['size'] }}</span>

                        <div class="file-text-container">
                            <span class="file-name">{{ f['name'] }}</span>
                            <span class="file-size">{{ f['size'] }}</span>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        
        {# --- MENU OVERLAY --- #}
        <div id="menu-overlay">
            <div class="menu-modal">
                <h3>Menu Aksi <button class="close-btn" id="close-menu">&times;</button></h3>
                <div class="menu-list">
                    </div>
            </div>
        </div>

        <div class="fixed-footer">
            {# Tombol Plus/Menu Cepat #}
            <a href="#" class="nav-icon" id="menu-toggle">
                <i class="fas fa-plus"></i>
                </a>
            
            {# Tombol Grid/List Toggle #}
            <a href="#" id="grid-toggle" class="nav-icon">
                <i class="fas fa-th-large"></i>
                <span id="view-label" style="display:none;">Grid</span> </a>
            
            {% if path != root_path %}
            {# Tombol Home #}
            <a href="/?path={{ root_path }}" class="nav-icon">
                <i class="fas fa-home"></i>
                </a>
            {% endif %}
            
            {# Tombol Kembali #}
            {% if path != root_path %}
            <a href="#" id="back-button" class="nav-icon">
                <i class="fas fa-arrow-left"></i>
                </a>
            {% endif %}

            {# Tombol Dunia/Browser (Berubah menjadi Hamburger saat Seleksi) #}
            <a href="#" id="browser-link" class="nav-icon">
                <i class="fas fa-globe"></i>
                </a>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileList = document.getElementById('file-list');
            const gridToggle = document.getElementById('grid-toggle');
            const backButton = document.getElementById('back-button');
            const menuToggle = document.getElementById('menu-toggle'); 
            const menuOverlay = document.getElementById('menu-overlay');
            const closeMenuButton = document.getElementById('close-menu');
            const browserLink = document.getElementById('browser-link'); 
            const menuModal = document.querySelector('.menu-modal');

            let pressTimer;
            const LONG_PRESS_THRESHOLD = 500; 
            let isSelecting = false;
            
            // --- FUNGSI UTILITY ---
            function getSelectedItems() {
                return document.querySelectorAll('.file-item.selected');
            }

            // --- 1. NONAKTIFKAN CONTEXT MENU MOBILE (TEKAN LAMA) ---
            document.addEventListener('contextmenu', function(e) {
                if ('ontouchstart' in window) { 
                     e.preventDefault();
                }
            });

            // --- 2. LOGIKA SELEKSI & MENU DINAMIS ---
            
            function handleSelectionAction(actionId, count) {
                let message = '';
                let shouldCloseModal = true; // Default: tutup modal setelah aksi

                switch(actionId) {
                    case 'selection-all':
                        fileList.querySelectorAll('.file-item').forEach(item => item.classList.add('selected'));
                        updateSelectionCount();
                        shouldCloseModal = false; // PERUBAHAN: JANGAN TUTUP MODAL
                        return; // Keluar dari fungsi karena aksi sudah selesai
                    case 'selection-slideshow':
                        message = `Memulai Slideshow untuk ${count} gambar!`;
                        break;
                    case 'selection-copy':
                        message = `Menyalin ${count} item ke clipboard!`;
                        break;
                    case 'selection-paste':
                        message = `Tempel item dari clipboard!`;
                        break;
                    case 'selection-move':
                        message = `Pindahkan ${count} item!`;
                        break;
                    case 'selection-delete':
                        if (confirm(`Yakin ingin menghapus ${count} item yang terpilih?`)) {
                            message = `Menghapus ${count} item!`;
                        } else {
                            return;
                        }
                        break;
                    case 'selection-compress':
                        message = `Compress ${count} item!`;
                        break;
                    case 'selection-extract':
                        message = `Extract file kompresi!`;
                        break;
                    default:
                        message = `Aksi ${actionId} dipanggil.`;
                }
                
                alert(message);
                
                if (shouldCloseModal) {
                    toggleSelectionMode(false); 
                }
            }

            function updateSelectionMenu() {
                const selectedItems = getSelectedItems();
                const count = selectedItems.length;
                const menuList = menuModal.querySelector('.menu-list');
                
                let allImages = count > 0;
                let isSingleCompress = count === 1;
                
                selectedItems.forEach(item => {
                    const isFile = item.classList.contains('file-file');
                    const path = item.getAttribute('data-path') || item.getAttribute('href') || '';
                    
                    if (isFile && !/\.(jpe?g|png|gif|webp)$/i.test(path)) { allImages = false; }
                    if (isFile && !/\.(zip|rar|7z|tar\.gz)$/i.test(path)) { isSingleCompress = false; }
                    if (!isFile || count > 1) { isSingleCompress = false; }
                    if (!isFile) { allImages = false; }
                });

                // --- REGENERASI ISI MENU HAMBURGER (Kondisional) ---
                menuList.innerHTML = '';
                const selectionActions = [];
                
                if (allImages) { selectionActions.push({ id: 'selection-slideshow', icon: 'fas fa-images', label: `Slideshow (${count})` }); }
                
                selectionActions.push(
                    { id: 'selection-all', icon: 'fas fa-check-double', label: `Pilih Semua` },
                    { id: 'selection-copy', icon: 'fas fa-copy', label: `Salin (${count})` },
                    { id: 'selection-move', icon: 'fas fa-external-link-alt', label: `Pindahkan` }
                );
                
                if (count > 0) {
                     selectionActions.push({ id: 'selection-compress', icon: 'fas fa-file-archive', label: `Compress (${count})` });
                }
                
                if (isSingleCompress) {
                     selectionActions.push({ id: 'selection-extract', icon: 'fas fa-file-export', label: `Extract` });
                }
                
                if (count > 0) {
                     selectionActions.push({ id: 'selection-delete', icon: 'fas fa-trash', label: `Hapus (${count})` });
                }

                // Render Menu Items
                selectionActions.forEach(action => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'menu-item selection-action';
                    itemDiv.id = action.id;
                    itemDiv.innerHTML = `<i class="${action.icon}"></i> ${action.label}`;
                    menuList.appendChild(itemDiv);
                    
                    itemDiv.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleSelectionAction(action.id, count);
                        if(action.id !== 'selection-all') { // Pengecekan tambahan di sini untuk jaga-jaga
                           toggleMenu(false);
                        }
                    });
                });
            }

            function updateSelectionCount() {
                const count = getSelectedItems().length;
                
                if (count > 0) {
                    if (!isSelecting) {
                        toggleSelectionMode(true);
                    }
                    updateSelectionMenu(); 
                } else {
                    if (isSelecting) {
                        toggleSelectionMode(false);
                    }
                }
            }

            function toggleSelectionMode(enable) {
                isSelecting = enable;
                
                menuToggle.querySelector('i').className = 'fas fa-plus'; 
                
                if (enable) {
                    browserLink.querySelector('i').className = 'fas fa-bars'; 
                } else {
                    browserLink.querySelector('i').className = 'fas fa-globe';
                    document.querySelectorAll('.file-item.selected').forEach(sel => sel.classList.remove('selected'));
                }
            }
            
            function toggleItemSelection(item) {
                item.classList.toggle('selected');
                updateSelectionCount();
            }

            // --- 3. EVENT LONG PRESS/KLIK (DELEGATION) ---
            
            fileList.addEventListener('touchstart', function(e) {
                const item = e.target.closest('.file-item');
                if (!item) return;

                clearTimeout(pressTimer);
                pressTimer = setTimeout(() => {
                    if (!isSelecting) {
                        e.preventDefault(); 
                        toggleSelectionMode(true);
                        toggleItemSelection(item); 
                    }
                }, LONG_PRESS_THRESHOLD);
            });

            fileList.addEventListener('touchend', function(e) {
                clearTimeout(pressTimer);
            });
            
            fileList.addEventListener('touchcancel', function(e) {
                clearTimeout(pressTimer);
            });
            
            fileList.addEventListener('click', function(e) {
                 const item = e.target.closest('.file-item');
                 if (!item) return;
                 
                 if (isSelecting) {
                     e.preventDefault(); 
                     toggleItemSelection(item);
                 } else if (pressTimer) {
                     clearTimeout(pressTimer);
                 }
            });

            // DESKTOP/Mouse Events
            fileList.addEventListener('mousedown', function(e) {
                 const item = e.target.closest('.file-item');
                 if (!item) return;
                 
                 clearTimeout(pressTimer);
                 pressTimer = setTimeout(() => {
                     if (!isSelecting) {
                         e.preventDefault(); 
                         toggleSelectionMode(true);
                         toggleItemSelection(item); 
                     }
                 }, LONG_PRESS_THRESHOLD);
            });

            fileList.addEventListener('mouseup', function(e) {
                clearTimeout(pressTimer);
            });
            
            fileList.addEventListener('mouseleave', function(e) {
                const item = e.target.closest('.file-item');
                if (item) clearTimeout(pressTimer);
            });
            
            fileList.addEventListener('contextmenu', (e) => {
                const item = e.target.closest('.file-item');
                if (!item) return;
                
                if (isSelecting) {
                     e.preventDefault(); 
                }
            });


            // --- 4. KLIK DI LUAR ITEM (KELUAR MODE SELEKSI) ---
            document.addEventListener('click', function(e) {
                if (isSelecting && !e.target.closest('.file-item') && !e.target.closest('#menu-overlay') && !e.target.closest('#menu-toggle') && !e.target.closest('#browser-link')) {
                    toggleSelectionMode(false);
                }
            });


            // --- 5. FUNGSI FOOTER NAVIGASI & MENU ---

            // Toggle Grid/List
            let isGridView = sessionStorage.getItem('viewMode') === 'grid';
            
            const setView = (isGrid) => {
                if (isGrid) {
                    fileList.classList.add('grid-view');
                    gridToggle.querySelector('i').className = 'fas fa-list fa-fw';
                    sessionStorage.setItem('viewMode', 'grid');
                } else {
                    fileList.classList.remove('grid-view');
                    gridToggle.querySelector('i').className = 'fas fa-th-large fa-fw';
                    sessionStorage.setItem('viewMode', 'list');
                }
            };
            setView(isGridView);

            gridToggle.addEventListener('click', function(e) {
                e.preventDefault();
                isGridView = !isGridView;
                setView(isGridView);
            });

            // Tombol Kembali
            if (backButton) {
                backButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.history.back();
                });
            }

            // Menu Overlay Logic
            const toggleMenu = (show) => {
                if (show) {
                    menuOverlay.style.display = 'flex';
                    if (isSelecting) {
                        menuModal.querySelector('h3').textContent = 'Menu Aksi Seleksi';
                        updateSelectionMenu(); 
                    } else {
                        menuModal.querySelector('h3').textContent = 'Menu Aksi Cepat';
                        menuModal.querySelector('.menu-list').innerHTML = `
                             <div class="menu-item" id="alternatif-cloud"><i class="fas fa-cloud-upload-alt"></i> Alternatif Cloud</div>
                             <div class="menu-item" id="add-folder"><i class="fas fa-folder-plus"></i> Tambah Folder Baru</div>
                        `;
                        menuModal.querySelectorAll('.menu-item').forEach(item => {
                            item.addEventListener('click', function(e) {
                                e.preventDefault(); 
                                alert(`Aksi Cepat: ${item.textContent.trim()} dipanggil!`);
                                toggleMenu(false);
                            });
                        });
                    }
                    setTimeout(() => menuOverlay.classList.add('active'), 10); 
                } else {
                    menuOverlay.classList.remove('active');
                    setTimeout(() => menuOverlay.style.display = 'none', 300);
                }
            };

            // Tombol PLUS (Menu Cepat)
            menuToggle.addEventListener('click', function(e) {
                e.preventDefault();
                toggleMenu(true);
            });
            
            // Tombol BROWSER/HAMBURGER (Menu Aksi Seleksi)
            browserLink.addEventListener('click', function(e) {
                e.preventDefault();
                if (isSelecting) {
                    toggleMenu(true);
                } 
            });

            // Menutup Menu
            closeMenuButton.addEventListener('click', function() {
                toggleMenu(false);
            });

            menuOverlay.addEventListener('click', function(e) {
                if (e.target.id === 'menu-overlay') {
                    toggleMenu(false);
                }
            });

        });
    </script>

</body>
</html>